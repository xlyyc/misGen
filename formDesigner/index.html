<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>业务设计器</title>
<link href="lib/jquery.ui/themes/redmond/jquery-ui.min.css" rel="stylesheet">
<link href="lib/jquery.ztree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet">
<link href="lib/jquery.ui.multiselect/css/jquery.multiselect.css" rel="stylesheet">
<link href="lib/jquery.ui.multiselect/css/jquery.multiselect.filter.css" rel="stylesheet">



<style type="text/css">
<!--
	* {
		margin:0;
		padding:0;
	}
	body{
		font: 12px "Trebuchet MS", sans-serif;
	}

-->
</style>

<script src="lib/jquery/jquery.min.js"></script>
<script src="lib/jquery.ui/jquery-ui-1.10.1.custom.min.js"></script>
<script src="lib/jquery.ui.multiselect/js/jquery.multiselect.min.js"></script>
<script src="lib/jquery.ui.multiselect/js/jquery.multiselect.filter.min.js"></script>
<script src="lib/jquery.ztree/js/jquery.ztree.all-3.5.js"></script>
<script src="lib/json2.js"></script>
<script src="lib/fixConsole.js"></script>
<script src="lib/jsonpath-0.8.0.js"></script>
<script src="src/wof/kernel/initNamespace.js"></script>


<script src="src/wof/util/Hashtable.js"></script>
<script src="src/wof/util/ObjectManager.js"></script>
<script src="src/wof/util/Observer.js"></script>
<script src="src/wof/util/ArrayList.js"></script>
<script src="src/wof/util/Selector.js"></script>
<script src="src/wof/util/SelectorList.js"></script>
<script src="src/wof/util/GlobalObject.js"></script>
<script src="src/wof/util/Tool.js"></script>


<script src="componentList.js"></script>


<script src="src/wof/kernel/initAOP.js"></script>

<script src="lib/wis/src/wis/kernel/initNamespace.js"></script>

<script src="lib/wis/src/wis/util/Hashtable.js"></script>
<script src="lib/wis/src/wis/util/ObjectManager.js"></script>
<script src="lib/wis/src/wis/util/Observer.js"></script>
<script src="lib/wis/src/wis/util/ArrayList.js"></script>
<script src="lib/wis/src/wis/util/Selector.js"></script>
<script src="lib/wis/src/wis/util/SelectorList.js"></script>
<script src="lib/wis/src/wis/util/GlobalObject.js"></script>
<script src="lib/wis/src/wis/util/Tool.js"></script>

<script src="lib/wis/src/wis/widget/Tab.js"></script>
<script src="lib/wis/src/wis/widget/Button.js"></script>

<script src="lib/wis/src/wis/kernel/initSystem.js"></script>


<script>

jQuery(function(){
	var headerHeight = 35;
	var sidebar1Width = 200;
	var sidebar2Width = 237;
	var container = jQuery('#container');
	var header = jQuery('#header');
	var sidebar1 = jQuery('#sidebar1');
	var sidebar2 = jQuery('#sidebar2');
	var content = jQuery('#content');
    var components = [];

	//设置布局
	function layout(){
		var windowWidth = jQuery(window).width();
		var windowHeight = jQuery(window).height();
		container.css('width', windowWidth+'px');
		container.css('height', windowHeight+'px');
		container.css('left', '0px');
		container.css('top', '0px');
		header.css('width', windowWidth+'px');
		header.css('height', headerHeight+'px');
		header.css('left', '0px');
		header.css('top', '0px');
		sidebar1.css('width', sidebar1Width+'px');
		sidebar1.css('height', (windowHeight-headerHeight-5)+'px');
		sidebar1.css('left', '0px');
		sidebar1.css('top', headerHeight+'px');		
		content.css('width', (windowWidth-sidebar1Width-sidebar2Width)+'px');
		content.css('height', (windowHeight-headerHeight-5)+'px');
		content.css('left', sidebar1Width+'px');
		content.css('top', headerHeight+'px');
		sidebar2.css('width', sidebar2Width+'px');
		sidebar2.css('height', (windowHeight-headerHeight-5)+'px');
		sidebar2.css('left', (windowWidth-sidebar2Width)+'px');
		sidebar2.css('top', headerHeight+'px');
	}
	//初始化左侧边栏
	function initSidebar1(){
		var windowWidth = jQuery(window).width();
		var windowHeight = jQuery(window).height();

        var tab = wof$.create('Tab');
        tab.setOnSendMessage([{id:'wof.widget.Tab_active',method:'return false;'}]);
        tab.setWidth(sidebar1Width-7);
        tab.setHeight(windowHeight-headerHeight-12);
        tab.setTop(0);
        tab.setLeft(0);
        tab.setActiveItemIndex(1);
        tab.appendTo(sidebar1);

        tab.insertItem({title:'构件'});

        var gridLayout1 = wof$.create('GridLayout');
        gridLayout1.setOnSendMessage([{id:'wof.bizWidget.GridLayout_active',method:'return false;'}]);
        gridLayout1.setWidth(sidebar1Width-18);
        gridLayout1.setHeight(tab.getHeight()-108);
        gridLayout1.setTop(0);
        gridLayout1.setLeft(0);
        gridLayout1.setOverflow('y');

        tab.insertNode(gridLayout1,1);

        var layoutComponents = [];
        var bizWidgetComponents = [];
        var widgetComponents = [];

        for(var i=0;i<wof$_layoutComponents.length;i++){
            var layoutComponentSpanner = wof$.create(wof$_layoutComponents[i]);
            layoutComponentSpanner.appendTo(gridLayout1);
            layoutComponents.push(layoutComponentSpanner);
            components.push(layoutComponentSpanner);
        }

        for(var i=0;i<wof$_bizWidgetComponents.length;i++){
            var bizWidgetComponentSpanner = wof$.create(wof$_bizWidgetComponents[i]);
            bizWidgetComponentSpanner.appendTo(gridLayout1);
            bizWidgetComponents.push(bizWidgetComponentSpanner);
            components.push(bizWidgetComponentSpanner);
        }

        for(var i=0;i<wof$_widgetComponents.length;i++){
            var widgetComponentSpanner = wof$.create(wof$_widgetComponents[i]);
            widgetComponentSpanner.appendTo(gridLayout1);
            widgetComponents.push(widgetComponentSpanner);
            components.push(widgetComponentSpanner);
        }


        for(var i=0;i<components.length;i++){
            var name = components[i].getMeta().name;
            for(var t=0;t<components.length;t++){
                var n = components[t].getMeta().name;
                if(name!=n){
                    var onReceiveMessage = components[t].getOnReceiveMessage();
                    onReceiveMessage.push({id: name+'_active',method:'this._receivePropertysAndRenderSelf(null);'});
                    components[t].setOnReceiveMessage(onReceiveMessage);
                }
            }
        }

        var compositeComponentsData = [];
        try{
            compositeComponentsData = JSON.parse(pageComponentTemplateList());
        }catch(e){
        }
        var objectBar = wof$.create('ObjectBar');
        objectBar.setCompositeComponents(compositeComponentsData);
        objectBar.setLayoutComponents(layoutComponents);
        objectBar.setBizWidgetComponents(bizWidgetComponents);
        objectBar.setWidgetComponents(widgetComponents);
        objectBar.setWidth(sidebar1Width-35);
        objectBar.setTop(0);
        objectBar.setLeft(0);
        objectBar.appendTo(gridLayout1);


        tab.insertItem({title:'层次视图'});

        var gridLayout2 = wof$.create('GridLayout');
        gridLayout2.setOnSendMessage([{id:'wof.bizWidget.GridLayout_active',method:'return false;'}]);
        gridLayout2.setWidth(sidebar1Width-18);
        gridLayout2.setHeight(tab.getHeight()-108);
        gridLayout2.setTop(0);
        gridLayout2.setLeft(0);
        //gridLayout2.setCss('ui-widget-content');
        gridLayout2.setOverflow('y');

        tab.insertNode(gridLayout2,2);

        tab.render();

        var objectInspector = wof$.create('ObjectInspector');
        objectInspector.setHeight(tab.getHeight()-108);
        objectInspector.setWidth(sidebar1Width-35);
        objectInspector.setTop(0);
        objectInspector.setLeft(0);
        objectInspector.appendTo(gridLayout2);

        objectInspector.render();     //由于树与tab样式冲突 所以需要在tab render后再添加树 并且直接渲染树
	}
    //重设左侧边栏
    function resizeSidebar1(){
        try{
            var windowWidth = jQuery(window).width();
            var windowHeight = jQuery(window).height();
            var tab = wof$.find('#'+(sidebar1.children('div[oid]').first().attr('oid'))).get(0);
            tab.setHeight(windowHeight-headerHeight-12);
            var ic = tab.getItemsCount();
            for(var i=1;i<=ic;i++){
                var node = tab.getNodesByItemIndex(i)[0];
                node.setHeight(tab.getHeight()-108);
            }
            tab.render();
        }catch(e){}
    }
	//初始化右侧边栏
	function initSidebar2(){
		var windowWidth = jQuery(window).width();
		var windowHeight = jQuery(window).height();

        var messageIds = [];
        for(var i=0;i<components.length;i++){
            var componentSpanner = components[i];
            messageIds.push(componentSpanner.getClassName()+'_render');
        }

        var tab = wof$.create('Tab');
        tab.setOnSendMessage([{id:'wof.widget.Tab_active',method:'return false;'}]);
        tab.setWidth(sidebar2Width-7);
        tab.setHeight(windowHeight-headerHeight-12);
        tab.setTop(0);
        tab.setLeft(0);
        tab.setActiveItemIndex(1);
        tab.appendTo(sidebar2);

        tab.insertItem({title:'属性'});
        var propertyBar = wof$.create('PropertyBar');
        propertyBar.setWidth(sidebar2Width-24);
        propertyBar.setHeight(tab.getHeight()-108);
        var method = 'if(!jQuery.isEmptyObject(message.sender.parameters)){this.setParameters(message.sender.parameters);this.setMeta(message.sender.meta);this.render();}';
        var onReceiveMessage = [];
        for(var i=0;i<messageIds.length;i++){
            onReceiveMessage.push({id:messageIds[i],method:method});
        }
        propertyBar.setOnReceiveMessage(onReceiveMessage);
        propertyBar.setTop(0);
        propertyBar.setLeft(4);
        tab.insertNode(propertyBar,1);

        tab.insertItem({title:'发送'});
        var onSendMessageBar = wof$.create('OnSendMessageBar');
        onSendMessageBar.setWidth(sidebar2Width-24);
        onSendMessageBar.setHeight(tab.getHeight()-108);
        var meth = 'if(!jQuery.isEmptyObject(message.sender.parameters)){this.setParameters(message.sender.parameters);this.setSendMessages(message.sender.meta.sendMessages);this.render();}';
        var receives = [];
        for(var i=0;i<messageIds.length;i++){
            receives.push({id:messageIds[i],method:meth});
        }
        onSendMessageBar.setOnReceiveMessage(receives);
        onSendMessageBar.setTop(0);
        onSendMessageBar.setLeft(4);
        tab.insertNode(onSendMessageBar,2);

        tab.insertItem({title:'监听'});
        var onReceiveMessageBar = wof$.create('OnReceiveMessageBar');
        onReceiveMessageBar.setWidth(sidebar2Width-24);
        onReceiveMessageBar.setHeight(tab.getHeight()-108);
        var met = 'if(!jQuery.isEmptyObject(message.sender.parameters)){this.setParameters(message.sender.parameters);this.render();}';
        var receiv = [];
        for(var i=0;i<messageIds.length;i++){
            receiv.push({id:messageIds[i],method:met});
        }
        onReceiveMessageBar.setOnReceiveMessage(receiv);
        onReceiveMessageBar.setTop(0);
        onReceiveMessageBar.setLeft(4);
        tab.insertNode(onReceiveMessageBar,3);
        var ic = tab.getItemsCount();
        for(var i=1;i<=ic;i++){
            var node = tab.getNodesByItemIndex(i)[0];
            node.setHeight(tab.getHeight()-108);
        }
        tab.render();

	}
	//重设右侧边栏
	function resizeSidebar2(){
		try{
			var windowWidth = jQuery(window).width();
			var windowHeight = jQuery(window).height();
            var tab = wof$.find('#'+(sidebar2.children('div[oid]').first().attr('oid'))).get(0);
            tab.setHeight(windowHeight-headerHeight-12);
            tab.render();
		}catch(e){}
	}
	//初始化工作区
	function initContent(){
		var windowWidth = jQuery(window).width();
		var windowHeight = jQuery(window).height();


        var flowLayoutHelper = wof$.create('FlowLayoutHelper');


       /*
        var gridLayout = wof$.create('GridLayout');
        gridLayout.setOverflow('auto');
        gridLayout.setWidth(windowWidth-sidebar1Width-sidebar2Width);
        gridLayout.setHeight(windowHeight-headerHeight-5);
        gridLayout.setTop(0);
        gridLayout.setLeft(0);
        gridLayout.appendTo(content);*/

        /*
        var pageComponent = wof$.create('PageComponent');
        pageComponent.setOverflow('auto');
        pageComponent.setWidth(windowWidth-sidebar1Width-sidebar2Width);
        pageComponent.setHeight(windowHeight-headerHeight-5);
        pageComponent.setTop(0);
        pageComponent.setLeft(0);
        pageComponent.appendTo(content);
         */

        var pageMetas = {};
        try{
            pageMetas = JSON.parse(getPageMetas());

        }catch(e){
            //alert(e);
        }

        if(!jQuery.isEmptyObject(pageMetas)){
            pageInputParam = pageMetas.inputParam;
            var node = eval('(new '+pageMetas.layout.className+'())');
            node.setData(pageMetas.layout);
            node.appendTo(content);

            node.render();
        }else{
            var itemHeight = 70;
            var width = 811;

            var flowLayout = wof$.create('FlowLayout');
            flowLayout.setLeft(0);
            flowLayout.setTop(0);
            flowLayout.setWidth(width);
            flowLayout.setCols(4);
            flowLayout.setItemHeight(60);
            var method = 'var layout = this.clone();'
             + '\n layout.setTop(300);'
             + '\n layout.appendTo(this.parentNode());'
             + '\n layout.render();'
             +'\n return false;';
            // flowLayout.setOnReceiveMessage([{id:'wof.widget.Button_mousedown',priority:50,method:method}]);
             //flowLayout.setOnSendMessage([{id:'wof.bizWidget.FlowLayout_render',method:'console.log(this.getCols());'}]);

            var sectionData1 = {title:'默认分组1',width:width,titleHeight:30,cols:2,itemHeight:300};
            flowLayout.insertSection(sectionData1);

            var voucherComponent = wof$.create('VoucherComponent');
            voucherComponent.setLeft(0);
            voucherComponent.setTop(0);
            voucherComponent.setWidth(500);
            voucherComponent.setItemHeight(60);
            voucherComponent.setViewType('tab');
            voucherComponent.insertVoucherItemGroup({groupCaption:'表头分组1',width:500,titleHeight:25,colsNum:4,itemHeight:45});
            voucherComponent.insertVoucherItemGroup({groupCaption:'表头分组2',width:500,titleHeight:25,colsNum:2,itemHeight:45});

            var voucherItemData1 = {
                colspan:'2',
                rowspan:'1',
                isFixItem:'true',
                itemName:'itemName1',
                visiable:'true',
                itemLabel:'姓名',
                dataField:'xm',
                dateTimeBoxFormat:'',
                readOnly:'false',
                required:'false',
                length:'',
                min:'',
                max:'',
                regExp:'',
                checkErrorInfo:'',
                visbleType:'select',
                selectPattern:'',
                useMultiSelect:'',
                labelWidth:'160',
                inputWidth:'100',
                inputHeight:'20',
                linkageItem:'',
                tipValue:''
            };
            voucherComponent.insertVoucherItem(voucherItemData1, {rowNum:1,colNum:1}, 1);

            flowLayout.insertNode(voucherComponent,{row:1,col:1},1,{isFixItem:false,rowspan:2});

            //voucherComponent.render();


            var json = voucherComponent.getData();
            var voucherComponent2 = wof$.create('VoucherComponent');
            voucherComponent2.insertVoucherItemGroup({groupCaption:'表头分组2',width:500,titleHeight:25,colsNum:2,itemHeight:45});

            voucherComponent2.setData(json);
            voucherComponent2.insertVoucherItemGroup({groupCaption:'表头分组3',width:500,titleHeight:25,colsNum:2,itemHeight:45});

            flowLayout.insertNode(voucherComponent2,{row:1,col:2},1);

            //voucherComponent2.render();

            //flowLayout.getDomInstance().css('height', '630px');
            //flowLayout.childNodes()[0].getDomInstance().css('height','630px');
            flowLayout.render();

            flowLayout.appendTo(content);

        }

    }
	//重设工作区
	function resizeContent(){
		try{
			var windowWidth = jQuery(window).width();
			var windowHeight = jQuery(window).height();
			var layout = getContentLayout();
            layout.setWidth(windowWidth-sidebar1Width-sidebar2Width);
            layout.setHeight(windowHeight-headerHeight-5);

            layout.sendMessage('wof.bizWidget.FlowLayout_resize');
		}catch(e){}
	}
	jQuery(window).load(function(){
        layout();
        initSidebar1();
        initContent();
		initSidebar2();
	});
	jQuery(window).resize(function(){
		layout();
		resizeSidebar1();
        resizeContent();
		resizeSidebar2();
	});
	jQuery("#pageParamBtn,#saveBtn,#saveToCompositeComponentBtn").button().click(function(event){
		event.preventDefault();
		var id = jQuery(event.target).attr('id');
        if(id=='pageParamBtn'){
            wof.customWindow.PageParamWindow.run();
        }else if(id=='saveBtn'){

            var json = {};
			var layout = getContentLayout();

            //将叶子节点数据拉平导出
            var _components = [];
            var _commandComponents = [];
            function _getLeafData(node){
                var clz = node.getClassName();
                var shortName = clz.substring(clz.lastIndexOf('.')+1);
                var package =  clz.substring(0,clz.lastIndexOf(shortName)-1);
                var spann = eval(package+'.spanner.'+shortName+'Spanner');
                if(spann!=null){
				 
						if(spann.prototype.exportData!=null){
                            if(clz.indexOf('wof.bizWidget')>=0){
                                var componentData = {};
                                componentData['ID'] = node.getComponentId();
                                componentData['CallStr'] = node.getCallStr();
                                componentData['ControlType'] = shortName;
                                componentData['ControlContext'] = spann.prototype.exportData(node);
                                _components.push(componentData);
                            }else{
                                _commandComponents.push(spann.prototype.exportData(node));
                            }
						}

                }
                var childNodes = node.childNodes();
                if(childNodes.length>0){
                    for(var i=0; i<childNodes.length; i++){
                        _getLeafData(childNodes[i]);
                    }
                }
            }

            _getLeafData(layout);

            var _inputParam = [];
            function _getInputParam(){
                for(var name in pageInputParam){
                    _inputParam.push(pageInputParam[name]);
                }
            }
		
            _getInputParam();

            json.inputParam = _inputParam;
            json.components = _components;
            json.commandComponents = _commandComponents;
            json.layout = layout.getData();

            try{
                setPageMetas(JSON.stringify(json));
            }catch(e){
                //alert(e);
            }
		}else if(id=='saveToCompositeComponentBtn'){
            jQuery('#dialog-form').dialog({
                autoOpen: false,
                height:200,
                width: 300,
                modal: true,
                buttons:{
                    '保存':function(){
                        var name = jQuery('#dialog_form_name').val();
                        if(name!=null&&name.length>0){
                            var templateData = null;
                            var cutObj = wof$.find('#'+(wof.util.GlobalObject.get('cutObjectId'))).get(0);
                            if(cutObj!=null){
                                if(window.confirm('是否只保存剪切板中的内容？')){
                                    templateData = cutObj.getData();
                                }else{
                                    templateData = getContentLayout().getData();
                                }
                            }else{
                                templateData = getContentLayout().getData();
                            }

                            try{
                                savePageComponentTemplate(wof.util.Tool.uuid(), name, JSON.stringify({'templateData':templateData}));
                            }catch(e){
                                //alert(e);
                            }

                        }
                        jQuery(this).dialog('close');
                    },
                    '关闭':function(){
                        jQuery(this).dialog('close');
                    }
                }
            });
            jQuery('#dialog-form').dialog('open');
        }
	});
});

window.getContentLayout = function(){
    return wof$.find('#'+(jQuery('#content').children('div[oid]').first().attr('oid'))).get(0);
}
var pageInputParam = {};

</script>
</head>
<body>
<div id="container" style="position:absolute;">
	<div id="header" style="position:absolute;background-color:#fff;border-bottom:1px solid black;z-index:90000">
        <input type="button" id="pageParamBtn" value="页面参数" />
        <input type="button" id="saveBtn" value="保存" />
        <input type="button" id="saveToCompositeComponentBtn" value="保存为模板" />
    </div>
	<div id="sidebar1" style="position:absolute;z-index:90000;">
    	
    </div>
    <div id="content" style="position:absolute;z-index: auto;">
    	
    </div>
    <div id="sidebar2" style="position:absolute;z-index:90000;">
    	
    </div>
</div>

<div id="dialog-form" title="保存为模板">
    <p class="validateTips">名称</p>
    <p><input type="text" id="dialog_form_name" class="text" /></p>
</div>
</body>
</html>
